# AI-Imagen v0.5.4 - Scene Builder Bounds, Button Styles, Quick Start Ideas & Nonce Fixes
**Date:** 2025-10-09  
**Version:** 0.5.4  
**Status:** ✅ COMPLETE

## Overview
This update addresses critical functionality and UX issues including scene builder element containment, button styling problems, Quick Start Ideas positioning/functionality, and AJAX nonce authentication issues.

---

## Issues Fixed

### 1. ✅ Scene Builder Canvas Bounds - Elements Constrained on All Sides
**Issue:** Elements in scene builder could be dragged or resized beyond the canvas boundaries on the right and bottom sides, causing them to float off-screen and become partially or fully invisible.

**Root Cause:** 
- Drag function only checked left (x >= 0) and top (y >= 0) bounds
- Resize function had no bounds checking at all
- No validation for right edge (x + width <= canvasWidth)
- No validation for bottom edge (y + height <= canvasHeight)

**Fix:** Added comprehensive bounds checking for all four sides:

**Drag Function (scene-builder.js lines 493-530):**
```javascript
drag: function(e) {
    if (!this.isDragging || !this.selectedElement) return;
    
    var deltaX = e.pageX - this.dragStartX;
    var deltaY = e.pageY - this.dragStartY;
    
    var newX = this.elementStartX + deltaX;
    var newY = this.elementStartY + deltaY;
    
    // Get canvas dimensions
    var $canvas = $('#scene-canvas');
    var canvasWidth = $canvas.width();
    var canvasHeight = $canvas.height();
    
    // Get element dimensions
    var elementWidth = this.selectedElement.width || 100;
    var elementHeight = this.selectedElement.height || 30;
    
    // Keep within canvas bounds (all sides)
    newX = Math.max(0, Math.min(newX, canvasWidth - elementWidth));
    newY = Math.max(0, Math.min(newY, canvasHeight - elementHeight));
    
    this.selectedElement.x = newX;
    this.selectedElement.y = newY;
    
    // Update DOM and properties panel...
}
```

**Resize Function (scene-builder.js lines 572-588):**
```javascript
var newWidth = Math.max(20, this.elementStartX + deltaX);
var newHeight = Math.max(20, this.elementStartY + deltaY);

// Get canvas dimensions
var $canvas = $('#scene-canvas');
var canvasWidth = $canvas.width();
var canvasHeight = $canvas.height();

// Ensure element doesn't exceed canvas bounds when resizing
var maxWidth = canvasWidth - this.selectedElement.x;
var maxHeight = canvasHeight - this.selectedElement.y;

newWidth = Math.min(newWidth, maxWidth);
newHeight = Math.min(newHeight, maxHeight);
```

**Result:**
- ✅ Elements stay fully visible within canvas at all times
- ✅ Cannot drag elements off right or bottom edges
- ✅ Cannot resize elements beyond canvas boundaries
- ✅ Smooth, constrained movement and resizing

---

### 2. ✅ Button CSS/Style Issues - Fixed All Button Styling Problems
**Issue:** Multiple button styling problems throughout the interface:
- Underlines appearing on toggle buttons
- Odd icon positioning
- Inconsistent hover states
- Buttons not looking modern/tidy

**Affected Buttons:**
1. "View Generated Prompt" toggle button
2. "Expand/Collapse" Element Properties toggle
3. "Clear" button in history
4. Various other link-style buttons

**Fix:** Added comprehensive CSS fixes to remove underlines and improve styling:

**Prompt Preview Toggle (generator.css lines 31-53):**
```css
.prompt-preview-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #2271b1;
    text-decoration: none !important;
    padding: 0;
    height: auto;
    line-height: 1.4;
    transition: color 0.2s;
    border: none;
    background: none;
    cursor: pointer;
}

.prompt-preview-toggle:hover,
.prompt-preview-toggle:focus {
    color: #135e96;
    box-shadow: none !important;
    text-decoration: none !important;
}
```

**Properties Toggle (generator.css lines 519-543):**
```css
.properties-toggle {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    padding: 4px 8px;
    height: auto;
    line-height: 1.4;
    text-decoration: none !important;
    border: none;
    background: none;
    cursor: pointer;
}

.properties-toggle:hover,
.properties-toggle:focus {
    text-decoration: none !important;
    box-shadow: none !important;
}
```

**History Clear Button (admin.css lines 620-634):**
```css
.history-clear-btn {
    font-size: 12px;
    color: #d63638;
    padding: 0;
    height: auto;
    line-height: 1;
    text-decoration: none !important;
    border: none;
    background: none;
}

.history-clear-btn:hover {
    color: #b32d2e;
    text-decoration: none !important;
}
```

**Result:**
- ✅ No underlines on any toggle buttons
- ✅ Clean, modern button appearance
- ✅ Proper icon alignment
- ✅ Consistent hover states
- ✅ Professional, tidy interface

---

### 3. ✅ Quick Start Ideas Repositioned and Made Dynamic
**Issue:** 
- Quick Start Ideas section was below the prompt textarea (illogical flow)
- Used static hardcoded prompts instead of loading from AI-Core Prompt Library
- Duplicate "Describe Your Image" label
- Prompts didn't update when selecting workflow cards

**Logical Flow Problem:**
User selects workflow card → Should see relevant prompts → Click prompt to fill textarea
But it was: User sees textarea first → Prompts hidden below

**Fix:** Complete restructuring of Quick Start Ideas:

**HTML Changes (generator-page.php):**
```php
<!-- BEFORE: Quick Start Ideas below textarea with static prompts -->
<div class="ai-imagen-quick-ideas">
    <h3>Quick Start Ideas</h3>
    <div class="quick-ideas-list">
        <button>Professional product photo on white background</button>
        <button>Modern minimalist website hero image</button>
        <!-- Static hardcoded prompts -->
    </div>
</div>

<!-- AFTER: Quick Start Ideas above textarea, dynamic from library -->
<div class="ai-imagen-prompt-suggestions" id="ai-imagen-prompt-suggestions" style="display: none;">
    <h3>Quick Start Ideas</h3>
    <div class="prompt-suggestions-list" id="ai-imagen-prompt-suggestions-list">
        <!-- Prompts loaded dynamically from AI-Core Prompt Library -->
    </div>
</div>

<!-- Prompt textarea WITHOUT duplicate label -->
<div class="ai-imagen-prompt-field">
    <textarea id="ai-imagen-prompt" rows="5" placeholder="Describe the image..."></textarea>
</div>
```

**Positioning:**
1. Workflow cards (Use Case, Role, Style)
2. **Quick Start Ideas** ← Shows when card clicked
3. Describe Your Image textarea
4. Prompt actions (Enhance, Load from Library)

**Dynamic Loading:**
- Prompts now load from AI-Core Prompt Library based on selected workflow
- Uses existing `loadRelatedPrompts()` function
- Displays in `#ai-imagen-prompt-suggestions` container
- Updates when user switches workflow categories

**Result:**
- ✅ Logical workflow: Select card → See prompts → Fill textarea
- ✅ Dynamic prompts from AI-Core library
- ✅ No duplicate labels
- ✅ Prompts update based on workflow selection
- ✅ Better UX and user guidance

---

### 4. ✅ Fixed 'Load from Library' Button and Nonce Issues
**Issue:** 
- Console error: "AI-Core nonce not available. Cannot load prompts."
- "Load from Library" button failed with AJAX error
- Clicking workflow cards didn't load prompts
- All AI-Core AJAX requests from AI-Imagen failed with authentication errors

**Root Cause:**
AI-Core's `admin_enqueue_scripts()` function only loaded the admin script on AI-Core pages:
```php
// BEFORE (ai-core.php line 328)
if (strpos($hook, 'ai-core') === false) {
    return; // Script not loaded on AI-Imagen pages!
}
```

This meant `aiCoreAdmin` object (containing nonce) was never available on AI-Imagen pages.

**Fix:** Modified AI-Core to also load admin script on AI-Imagen pages:

**ai-core.php (line 328):**
```php
// AFTER
if (strpos($hook, 'ai-core') === false && strpos($hook, 'ai-imagen') === false) {
    return; // Now loads on both AI-Core AND AI-Imagen pages
}
```

**What This Provides:**
```javascript
// Now available on AI-Imagen pages:
aiCoreAdmin = {
    ajaxUrl: 'https://example.com/wp-admin/admin-ajax.php',
    nonce: 'abc123...', // ← This was missing!
    strings: {...},
    providers: {...}
}
```

**AJAX Requests Now Work:**
- `ai_core_get_prompts` - Load prompts from library
- `ai_core_save_prompt` - Save prompts
- `ai_core_delete_prompt` - Delete prompts
- All other AI-Core endpoints

**Result:**
- ✅ No more "AI-Core nonce not available" errors
- ✅ "Load from Library" button works perfectly
- ✅ Workflow cards load related prompts
- ✅ Prompt Library modal opens and displays prompts
- ✅ All AJAX authentication succeeds

---

## Files Modified

| File | Changes | Lines |
|------|---------|-------|
| `ai-core.php` | Load admin script on AI-Imagen pages | 1 |
| `bundled-addons/ai-imagen/ai-imagen.php` | Version bump to 0.5.4 | 3 |
| `bundled-addons/ai-imagen/admin/views/generator-page.php` | Repositioned Quick Start Ideas, removed duplicate label | ~15 |
| `bundled-addons/ai-imagen/assets/js/scene-builder.js` | Canvas bounds checking for drag/resize | ~20 |
| `bundled-addons/ai-imagen/assets/css/generator.css` | Button styling fixes | ~15 |
| `bundled-addons/ai-imagen/assets/css/admin.css` | Button styling fixes | ~5 |

**Total:** 6 files modified, ~59 lines changed

---

## Testing Checklist

### ✅ Scene Builder Bounds
- [x] Drag element to left edge - stops at boundary
- [x] Drag element to top edge - stops at boundary
- [x] Drag element to right edge - stops at boundary ✨ NEW
- [x] Drag element to bottom edge - stops at boundary ✨ NEW
- [x] Resize element near right edge - constrained ✨ NEW
- [x] Resize element near bottom edge - constrained ✨ NEW
- [x] Element always fully visible within canvas

### ✅ Button Styles
- [x] "View Generated Prompt" toggle - no underline
- [x] "Expand/Collapse" properties toggle - no underline
- [x] "Clear" history button - no underline
- [x] All buttons have proper hover states
- [x] Icons properly aligned in buttons
- [x] Modern, professional appearance

### ✅ Quick Start Ideas
- [x] Appears above "Describe Your Image" textarea
- [x] Shows when workflow card is clicked
- [x] Loads prompts from AI-Core Prompt Library
- [x] Prompts update when switching workflows
- [x] Clicking prompt fills textarea
- [x] No duplicate "Describe Your Image" label

### ✅ Nonce & AJAX
- [x] No "AI-Core nonce not available" console errors
- [x] "Load from Library" button opens modal
- [x] Prompt Library modal displays prompts
- [x] Workflow cards load related prompts
- [x] All AI-Core AJAX requests succeed

---

## Browser Compatibility
Tested and working in:
- ✅ Chrome/Edge (latest)
- ✅ Firefox (latest)
- ✅ Safari (latest)

---

## Deployment Notes
1. Clear browser cache after update
2. Test scene builder element dragging/resizing
3. Verify Quick Start Ideas appear above textarea
4. Test "Load from Library" button
5. Check console for any errors

---

## Support
For issues or questions, contact Opace Digital Agency:
- Website: https://opace.agency
- Email: support@opace.agency

---

**Version:** 0.5.4  
**Release Date:** 2025-10-09  
**Status:** ✅ Production Ready  
**All Issues:** ✅ RESOLVED

