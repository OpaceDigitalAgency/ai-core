# AI-Imagen Fixes - 2025-10-08

## Version 0.4.4

### Issues Fixed

#### 1. Scene Builder Prompt Format Improvement
**Issue:** Scene Builder prompt format was verbose and difficult to read.

**Fix:** Updated `generateSceneDescription()` function in `assets/js/scene-builder.js` to use numbered list format:
- Changed from: "Use a 1:1 square canvas. Place the text box..."
- Changed to: "1. Use a 1:1 square canvas. 2. Place the text box..."
- Added sequential numbering to all instructions for better clarity
- Maintained the instruction to not display layout instructions in the final image

**Files Modified:**
- `bundled-addons/ai-imagen/assets/js/scene-builder.js` (lines 773-838)

#### 2. Save to Library - Base64 Image Support
**Issue:** "Save to Library" button was failing when trying to save Base64-encoded images (data URLs) from providers like Gemini.

**Fix:** Enhanced `save_to_library()` and `download_image()` methods in `includes/class-ai-imagen-media.php`:
- Added Base64 data URL detection using regex pattern: `/^data:image\/(\w+);base64,(.+)$/`
- Implemented Base64 decoding for data URLs before saving to temp file
- Maintained backward compatibility with regular HTTP/HTTPS URLs
- Added proper error handling for Base64 decode failures
- Added validation for empty image URLs

**Files Modified:**
- `bundled-addons/ai-imagen/includes/class-ai-imagen-media.php` (lines 47-156)

**Technical Details:**
- The function now checks if the URL is a Base64 data URL
- If yes, it decodes the Base64 data and saves it directly to a temp file
- If no, it uses the existing `wp_remote_get()` method to download from URL
- Both paths converge to use `media_handle_sideload()` for WordPress media library integration

#### 3. Version Updates for Cache Busting
**Issue:** Browser caching could prevent users from seeing the latest fixes.

**Fix:** Updated version numbers across all relevant files:
- Main plugin version: 0.4.3 → 0.4.4
- CSS file versions: 0.4.2 → 0.4.4
- JavaScript file versions: 0.4.3 → 0.4.4

**Files Modified:**
- `bundled-addons/ai-imagen/ai-imagen.php`
- `bundled-addons/ai-imagen/assets/css/admin.css`
- `bundled-addons/ai-imagen/assets/css/generator.css`
- `bundled-addons/ai-imagen/assets/js/scene-builder.js`

**Note:** The plugin already uses `AI_IMAGEN_VERSION` constant for enqueuing scripts and styles, so cache busting is automatic.

### Issues Investigated (No Changes Required)

#### 1. Statistics Page Styling
**Issue Reported:** Lost styling for statistics sections.

**Investigation:** 
- Checked CSS classes in `assets/css/admin.css`
- Confirmed that `.ai-core-stats-grid`, `.stat-box`, `.stat-label`, and `.stat-value` classes are properly defined
- CSS is being enqueued with version number for cache busting
- The styling is present and should be working correctly

**Possible Causes:**
- Browser cache (cleared by version update)
- CSS file not loading due to server/permission issues
- Conflicting CSS from theme or other plugins

**Recommendation:** 
- Clear browser cache and hard refresh (Ctrl+Shift+R or Cmd+Shift+R)
- Check browser console for CSS loading errors
- Verify file permissions on `assets/css/admin.css`

#### 2. Prompt Library Showing Zero Prompts
**Issue Reported:** Prompt Library shows "zero prompts installed" even though groups are created.

**Investigation:**
- Checked Prompt Library rendering in `admin/class-ai-core-prompt-library.php`
- Confirmed that the page uses server-side rendering
- Verified AJAX handlers for getting prompts are properly registered
- The code correctly organises prompts by group and displays them

**Possible Causes:**
- Database tables exist but prompts table is empty (only groups were created)
- Prompts were not imported or created yet
- Database query issue (unlikely as groups are showing)

**Recommendation:**
- Check if prompts actually exist in the database: `SELECT COUNT(*) FROM wp_ai_core_prompts`
- Try importing prompts using the Import button
- Create a test prompt manually to verify the system is working
- Check for JavaScript console errors that might prevent prompt display

### Testing Recommendations

1. **Scene Builder:**
   - Add text, logo, icon, or image elements to the canvas
   - Verify the prompt preview shows numbered instructions
   - Generate an image and verify the layout instructions are not visible in the output

2. **Save to Library:**
   - Generate an image using Gemini (which returns Base64 data)
   - Click "Save to Library" button
   - Verify the image is saved to WordPress media library
   - Check that metadata is properly attached to the image

3. **Cache Busting:**
   - Clear browser cache
   - Hard refresh the page (Ctrl+Shift+R or Cmd+Shift+R)
   - Verify all CSS and JavaScript files load with version 0.4.4

4. **Statistics Page:**
   - Navigate to AI Core → Statistics
   - Verify the statistics grid displays properly
   - Check that stat boxes have proper styling and layout

5. **Prompt Library:**
   - Navigate to AI Core → Prompt Library
   - Verify groups are displayed
   - Check if prompts are shown within groups
   - Try creating a new prompt to verify functionality

### Deployment Notes

- All changes are backward compatible
- No database schema changes required
- No settings changes required
- Users should clear browser cache after update

### Known Limitations

1. **Scene Builder Prompt Format:**
   - AI models may still interpret layout instructions differently
   - Some models may ignore positioning instructions
   - Results may vary by provider and model

2. **Base64 Image Handling:**
   - Large Base64 images may cause memory issues
   - No size validation before decoding
   - Consider adding file size checks in future updates

### Future Improvements

1. Add file size validation for Base64 images
2. Implement progress indicators for large image saves
3. Add retry logic for failed image saves
4. Consider adding image compression options
5. Add more detailed error messages for debugging

---

**Version:** 0.4.4  
**Date:** 2025-10-08  
**Author:** AI Core Development Team

