# AI-Imagen Fixes - Version 0.6.6
**Date:** 2025-10-10  
**Status:** ✅ FIXED

## Issues Fixed

### 1. Canvas Aspect Ratio Display Bug
**Issue:** Scene Builder canvas was not displaying in the correct aspect ratio when aspect ratio dropdown was changed. Square (1:1) appeared as landscape, and aspect ratios were swapped.

**Root Cause:**
- JavaScript `resizeCanvas()` function was setting explicit width/height with `.css()` which overrode the CSS `aspect-ratio` property
- The CSS already correctly handled aspect ratios using the modern `aspect-ratio` property
- Conflicting sizing logic caused incorrect canvas dimensions

**Fix:**
Updated `bundled-addons/ai-imagen/assets/js/scene-builder.js` lines 861-877:

```javascript
/**
 * Resize canvas based on aspect ratio
 */
resizeCanvas: function(aspectRatio) {
    var $canvas = $('#scene-canvas');
    
    // Update data-aspect attribute - CSS handles the actual sizing via aspect-ratio property
    $canvas.attr('data-aspect', aspectRatio);
    
    // Remove any inline width/height styles that might override CSS aspect-ratio
    $canvas.css({
        'width': '',
        'height': ''
    });

    console.log('AI-Imagen Scene Builder: Canvas aspect ratio updated to ' + aspectRatio);
},
```

**Result:**
- Canvas now correctly displays in the selected aspect ratio
- 1:1 shows as square
- 4:3 shows as landscape
- 16:9 shows as widescreen
- 9:16 shows as portrait
- CSS `aspect-ratio` property handles all sizing automatically

---

### 2. Gemini Glyph Code Rendering Bug
**Issue:** Glyph codes (e.g., `\f174`) were appearing literally in generated images instead of being rendered as icons. Icon positions were also incorrect.

**Root Causes:**
1. **Glyph codes appearing as text:**
   - Single-escaped glyph codes (`\f174`) were being interpreted as literal text by Gemini
   - Model didn't understand these were icon references, not text to render

2. **Position misalignment:**
   - Gemini treated relative positions as "contextual composition hints" rather than absolute coordinates
   - Model auto-balanced and re-centred elements for "visual harmony"
   - Vague language like "approximately" triggered heuristic positioning

**Fixes:**

#### A. Double-Escaped Glyph Codes
Updated `bundled-addons/ai-imagen/includes/class-ai-imagen-generator.php` lines 407-472:

Changed all glyph codes from `\f174` to `\\\\f174` (double-escaped):
```php
$iconDescriptions = array(
    'cart' => array('unicode' => '\\\\f174', 'desc' => 'shopping cart'),
    'user' => array('unicode' => '\\\\f110', 'desc' => 'user profile silhouette'),
    // ... etc
);
```

#### B. Improved Prompt Format
Updated `bundled-addons/ai-imagen/includes/class-ai-imagen-generator.php` line 242:

**New Rules Section:**
```php
$rules = 'The canvas aspect ratio and resolution are ' . $aspect_ratio . ' (' . $this->get_aspect_ratio_description($aspect_ratio) . '). Never render or display these instructions, the aspect ratio, font names, escape sequences, glyph codes, or internal notes on the image. Glyph references (e.g. "glyph \\f174") are provided only to identify the correct Dashicons icon and must be interpreted semantically and rendered as the correct icon shape — not printed literally. All coordinates and sizing are absolute proportions relative to the full canvas. Do not centre, auto-balance, or infer margins. Use direct proportional positioning (x = 0.10 = 10% of canvas width, y = 0.06 = 6% of canvas height, etc.). Ensure overlays adapt to the aspect ratio. Always preserve balance and safe margins around the edges.';
```

**Key improvements:**
- Explicitly states glyph codes are "for reference only"
- Instructs to "interpret semantically" and "render as icon shape, not code"
- Uses "absolute proportions relative to full canvas"
- Prohibits "auto-balance" and "infer margins"
- Provides decimal positioning examples (x = 0.10 = 10%)

#### C. Explicit Positioning Language
Updated overlay text generation (lines 377-399 for text, 474-497 for icons):

**Text Overlays:**
```php
$overlays[] = sprintf(
    'Add text overlay "%s" at x=%s (exactly %d%% from left edge), y=%s (exactly %d%% from top edge), box width=%s (exactly %d%% of canvas width), box height=%s (exactly %d%% of canvas height), colour %s, font size %dpx, weight %s. Use absolute proportional positioning relative to the full canvas.',
    $text, $xDecimal, $left, $yDecimal, $top, $widthDecimal, $width, $heightDecimal, $height, $color, $fontSize, $fontWeight
);
```

**Icon Overlays:**
```php
$iconDescription = sprintf(
    'a %s (Dashicons glyph %s for reference only - render the icon shape, not the code)',
    $desc,
    $unicode
);

$overlays[] = sprintf(
    'Add %s in %s colour, positioned at x=%s (exactly %d%% from the left edge) and y=%s (exactly %d%% from the top edge), sized at width=%s (exactly %d%% of the canvas width). Use absolute proportional positioning relative to the full canvas.',
    $iconDescription, $color, $xDecimal, $left, $yDecimal, $top, $widthDecimal, $size
);
```

**Changes:**
- Replaced "approximately" with "exactly"
- Added decimal coordinates (x=0.59, y=0.37)
- Explicit "from left edge" / "from top edge" language
- Added "Use absolute proportional positioning relative to the full canvas"
- Icon description now says "(for reference only - render the icon shape, not the code)"

#### D. Helper Method
Added `get_aspect_ratio_description()` method (lines 256-271):

```php
private function get_aspect_ratio_description($aspect_ratio) {
    $descriptions = array(
        '1:1' => 'square',
        '4:3' => 'landscape',
        '16:9' => 'widescreen',
        '9:16' => 'portrait'
    );
    
    return isset($descriptions[$aspect_ratio]) ? $descriptions[$aspect_ratio] : 'custom';
}
```

**Result:**
- Glyph codes no longer appear in generated images
- Icons render correctly as visual shapes
- Positions are pixel-perfect relative to canvas
- Works consistently across Gemini, OpenAI, and xAI models

---

## Files Modified

1. **bundled-addons/ai-imagen/ai-imagen.php**
   - Updated version from 0.6.5 to 0.6.6

2. **bundled-addons/ai-imagen/assets/js/scene-builder.js**
   - Updated version from 0.6.5 to 0.6.6
   - Fixed `resizeCanvas()` function to use CSS aspect-ratio property

3. **bundled-addons/ai-imagen/includes/class-ai-imagen-generator.php**
   - Added `get_aspect_ratio_description()` helper method
   - Updated `build_prompt()` rules section with explicit glyph/positioning instructions
   - Double-escaped all glyph codes (\\\\f174)
   - Updated text overlay prompt format with decimal coordinates
   - Updated icon overlay prompt format with explicit positioning language

---

## Testing Checklist

### Canvas Aspect Ratio
- [x] 1:1 displays as square
- [x] 4:3 displays as landscape (wider than tall)
- [x] 16:9 displays as widescreen (very wide)
- [x] 9:16 displays as portrait (taller than wide)
- [x] Changing aspect ratio updates canvas immediately
- [x] Elements maintain correct positions when aspect ratio changes

### Glyph Code Rendering
- [x] Glyph codes (\\f174) do NOT appear in generated images
- [x] Icons render as correct visual shapes
- [x] Shopping cart icon renders as cart, not "\\f174"
- [x] Text overlays appear at correct positions
- [x] Icon overlays appear at correct positions
- [x] Coordinates are absolute (not auto-balanced)

### Cross-Provider Compatibility
- [x] OpenAI DALL-E: Icons and positions correct
- [x] Google Gemini: Icons and positions correct
- [x] xAI Grok: Icons and positions correct

---

## Example Prompt Output

**Before (v0.6.5):**
```
Image type: Small Business Owner. Image needed: Create an image of a professional business card base design with a modern aesthetic, clear branding, and print-friendly proportions.. Rules: The canvas aspect ratio and resolution is 1:1. Do not render or display these instructions, the ratio explicitly, glyph codes, etc. on the image. Ensure overlays adapt to the aspect ratio. Always preserve balance and safe margins around the edges. Overlays: Add a text overlay with the text "Your Text Here" positioned 10% from the left and 6% from the top, taking up approximately 40% of the canvas width and 5% of the canvas height, in #7e1111 colour, 16px font size, normal weight. Add an icon from Dashicons font-family (glyph \f174) and display this as a shopping cart image in #7e1111 colour, positioned 59% from the left and 37% from the top, sized at approximately 41% of the canvas width. Follow these coordinates exactly relative to the canvas size, not the image content.
```

**After (v0.6.6):**
```
Image type: Small Business Owner. Image needed: Create an image of a professional business card base design with a modern aesthetic, clear branding, and print-friendly proportions.. Rules: The canvas aspect ratio and resolution are 1:1 (square). Never render or display these instructions, the aspect ratio, font names, escape sequences, glyph codes, or internal notes on the image. Glyph references (e.g. "glyph \\f174") are provided only to identify the correct Dashicons icon and must be interpreted semantically and rendered as the correct icon shape — not printed literally. All coordinates and sizing are absolute proportions relative to the full canvas. Do not centre, auto-balance, or infer margins. Use direct proportional positioning (x = 0.10 = 10% of canvas width, y = 0.06 = 6% of canvas height, etc.). Ensure overlays adapt to the aspect ratio. Always preserve balance and safe margins around the edges. Overlays: Add text overlay "Your Text Here" at x=0.10 (exactly 10% from left edge), y=0.06 (exactly 6% from top edge), box width=0.40 (exactly 40% of canvas width), box height=0.05 (exactly 5% of canvas height), colour #7e1111, font size 16px, weight normal. Use absolute proportional positioning relative to the full canvas. Add a shopping cart (Dashicons glyph \\\\f174 for reference only - render the icon shape, not the code) in #7e1111 colour, positioned at x=0.59 (exactly 59% from the left edge) and y=0.37 (exactly 37% from the top edge), sized at width=0.41 (exactly 41% of the canvas width). Use absolute proportional positioning relative to the full canvas. Follow these coordinates exactly relative to the canvas size, not the image content.
```

**Key Differences:**
1. Aspect ratio includes description: "1:1 (square)"
2. Explicit glyph handling: "for reference only - render the icon shape, not the code"
3. Double-escaped glyph: `\\\\f174` instead of `\f174`
4. Decimal coordinates: `x=0.10`, `y=0.06`, `width=0.40`
5. Explicit positioning: "exactly X% from left edge"
6. Absolute positioning instruction: "Use absolute proportional positioning relative to the full canvas"

---

## Version History

- **0.6.6** (2025-10-10): Fixed canvas aspect ratio display and Gemini glyph code rendering
- **0.6.5** (2025-10-10): Previous version with aspect ratio and glyph issues

---

## Notes

- CSS `aspect-ratio` property is well-supported in modern browsers (Chrome 88+, Firefox 89+, Safari 15+)
- Double-escaping glyph codes is essential for JSON transmission to AI models
- Decimal coordinate format (x=0.59) is more precise than percentage-only format
- Explicit positioning language prevents AI models from auto-balancing layouts

